{% include base_path %}

{% if post.header.teaser %}
  {% capture teaser %}{{ post.header.teaser }}{% endcapture %}
{% else %}
  {% assign teaser = site.teaser %}
{% endif %}

{% if post.id %}
  {% assign title = post.title | markdownify | remove: "<p>" | remove: "</p>" %}
{% else %}
  {% assign title = post.title %}
{% endif %}

<div class="{{ include.type | default: "list" }}__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    {% if include.type == "grid" and teaser %}
      <div class="archive__item-teaser">
        <img src=
          {% if teaser contains "://" %}
            "{{ teaser }}"
          {% else %}
            "{{ teaser | prepend: "/images/" | prepend: base_path }}"
          {% endif %}
          alt="">
      </div>
    {% endif %}

    <h2 class="archive__item-title" itemprop="headline">
      {% if post.link %}
        <a href="{{ post.link }}" onclick="toggleChart(event, '{{ post.title | slugify }}')">{{ title }}</a>
        <a href="{{ base_path }}{{ post.url }}" rel="permalink"><i class="fa fa-link" aria-hidden="true" title="permalink"></i><span class="sr-only">Permalink</span></a>
      {% else %}
        <a href="{{ base_path }}{{ post.url }}" rel="permalink" onclick="toggleChart(event, '{{ post.title | slugify }}')">{{ title }}</a>
      {% endif %}
    </h2>

    {% comment %} ... keep other existing sections the same ... {% endcomment %}

    {% assign citation_data = site.data.citations[post.title] %}
    {% if citation_data %}
      <div class="citation-metrics" id="chart-{{ post.title | slugify }}" style="display:none;">
        <h4>Citation Metrics</h4>
        <p>Total Citations: {{ citation_data.total_citations }}</p>
        <canvas id="citationChart-{{ post.title | slugify }}"></canvas>
        <script>
          (function() {
            // Store chart configuration
            var chartConfig{{ post.title | slugify }} = {
              type: 'line',
              data: {
                labels: {{ citation_data.citations_over_time | map: 'year' | jsonify }},
                datasets: [{
                  label: 'Citations Over Time',
                  data: {{ citation_data.citations_over_time | map: 'citations' | jsonify }},
                  borderColor: '#4A90E2',
                  backgroundColor: 'rgba(74, 144, 226, 0.1)',
                  tension: 0.3
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true }
                }
              }
            };

            // Initialize chart on first click
            window.initChart{{ post.title | slugify }} = function() {
              var ctx = document.getElementById('citationChart-{{ post.title | slugify }}');
              new Chart(ctx.getContext('2d'), chartConfig{{ post.title | slugify }});
              ctx.dataset.initialized = true;
            };
          })();
        </script>
      </div>
    {% endif %}
  </article>
</div>

<script>
// Global toggle function
function toggleChart(event, chartId) {
  event.preventDefault();
  const container = document.getElementById(`chart-${chartId}`);
  if (container) {
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    if (!container.querySelector('canvas').dataset.initialized) {
      window[`initChart${chartId}`]();
    }
  }
}
</script>